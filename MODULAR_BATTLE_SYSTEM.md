# ğŸ® æ¨¡å—åŒ–æˆ˜æ–—ç³»ç»Ÿæ¶æ„æ–‡æ¡£

## ğŸ“‹ ç›®å½•

1. [æ¦‚è¿°](#æ¦‚è¿°)
2. [æ¶æ„è®¾è®¡](#æ¶æ„è®¾è®¡)
3. [æ¨¡å—è¯¦è§£](#æ¨¡å—è¯¦è§£)
4. [æˆ˜æ–—æµç¨‹](#æˆ˜æ–—æµç¨‹)
5. [ä½¿ç”¨æŒ‡å—](#ä½¿ç”¨æŒ‡å—)
6. [æ‰©å±•å¼€å‘](#æ‰©å±•å¼€å‘)

---

## æ¦‚è¿°

æœ¬é¡¹ç›®é‡‡ç”¨**æ¨¡å—åŒ–æ¶æ„**é‡æ„äº†å®å¯æ¢¦æˆ˜æ–—ç³»ç»Ÿï¼Œå°†åŸæœ¬è€¦åˆåœ¨ä¸€èµ·çš„ä»£ç æ‹†åˆ†ä¸ºå¤šä¸ªç‹¬ç«‹çš„ã€èŒè´£å•ä¸€çš„æ¨¡å—ã€‚è¿™ç§è®¾è®¡æé«˜äº†ä»£ç çš„å¯ç»´æŠ¤æ€§ã€å¯æµ‹è¯•æ€§å’Œå¯æ‰©å±•æ€§ã€‚

### ğŸ¯ è®¾è®¡ç›®æ ‡

- **å•ä¸€èŒè´£åŸåˆ™**ï¼šæ¯ä¸ªæ¨¡å—åªè´Ÿè´£ä¸€ä¸ªç‰¹å®šçš„åŠŸèƒ½
- **ä½è€¦åˆé«˜å†…èš**ï¼šæ¨¡å—ä¹‹é—´é€šè¿‡æ¸…æ™°çš„æ¥å£é€šä¿¡
- **æ˜“äºæµ‹è¯•**ï¼šæ¯ä¸ªæ¨¡å—å¯ä»¥ç‹¬ç«‹æµ‹è¯•
- **æ˜“äºæ‰©å±•**ï¼šæ·»åŠ æ–°åŠŸèƒ½ä¸å½±å“ç°æœ‰æ¨¡å—

### ğŸ“Š é‡æ„å‰åå¯¹æ¯”

| æ–¹é¢ | é‡æ„å‰ | é‡æ„å |
|------|--------|--------|
| ä»£ç ç»„ç»‡ | æ‰€æœ‰é€»è¾‘æ··åœ¨ä¸€èµ· | æŒ‰åŠŸèƒ½åˆ†æ¨¡å— |
| å¯ç»´æŠ¤æ€§ | éš¾ä»¥å®šä½å’Œä¿®æ”¹ | æ¸…æ™°çš„æ¨¡å—è¾¹ç•Œ |
| å¯æµ‹è¯•æ€§ | éš¾ä»¥å•å…ƒæµ‹è¯• | æ¯ä¸ªæ¨¡å—å¯ç‹¬ç«‹æµ‹è¯• |
| å¯æ‰©å±•æ€§ | ä¿®æ”¹å½±å“èŒƒå›´å¤§ | åªéœ€ä¿®æ”¹ç›¸å…³æ¨¡å— |
| ä»£ç å¤ç”¨ | ä»£ç é‡å¤å¤š | æ¨¡å—å¯å¤ç”¨ |

---

## æ¶æ„è®¾è®¡

### ğŸ—ï¸ åˆ†å±‚æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         æ ¸å¿ƒè°ƒåº¦å±‚ (Core Layer)          â”‚
â”‚  MicroTurnScheduler + EventBus          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       é˜¶æ®µå¤„ç†å±‚ (Phase Layer)           â”‚
â”‚       BattlePhaseHandler                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       åŠ¨ä½œæ‰§è¡Œå±‚ (Action Layer)          â”‚
â”‚         ActionExecutor                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    è®¡ç®—ä¸ç®¡ç†å±‚ (Calculation Layer)      â”‚
â”‚  DamageCalculator + TypeEffectiveness   â”‚
â”‚     + StatusEffectManager               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         æ•°æ®å±‚ (Data Layer)              â”‚
â”‚    Pokemon Data + Type Data             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ”„ æ¨¡å—ä¾èµ–å…³ç³»

```
MicroTurnScheduler
â”œâ”€â”€ EventBus
â”œâ”€â”€ BattlePhaseHandler
â”‚   â”œâ”€â”€ ActionExecutor
â”‚   â”‚   â”œâ”€â”€ DamageCalculator
â”‚   â”‚   â”œâ”€â”€ TypeEffectiveness
â”‚   â”‚   â””â”€â”€ StatusEffectManager
â”‚   â””â”€â”€ StatusEffectManager
â””â”€â”€ æˆ˜æ–—é˜¶æ®µç®¡ç†
```

---

## æ¨¡å—è¯¦è§£

### 1ï¸âƒ£ DamageCalculator - ä¼¤å®³è®¡ç®—æ¨¡å—

**æ–‡ä»¶ä½ç½®ï¼š** `systems/battle/DamageCalculator.js`

**èŒè´£ï¼š** è®¡ç®—æˆ˜æ–—ä¸­çš„ä¼¤å®³å€¼

**æ ¸å¿ƒåŠŸèƒ½ï¼š**
- âœ… åŸºç¡€ä¼¤å®³è®¡ç®—ï¼ˆå®˜æ–¹å…¬å¼ï¼‰
- âœ… å±æ€§ç›¸å…‹å€ç‡
- âœ… åŒå±æ€§åŠ æˆï¼ˆSTABï¼‰
- âœ… æš´å‡»åˆ¤å®š
- âœ… å¤©æ°”ä¿®æ­£
- âœ… éšæœºæ³¢åŠ¨ï¼ˆ85%-100%ï¼‰

**APIï¼š**
```javascript
// è®¡ç®—ä¼¤å®³
DamageCalculator.calculateDamage(attacker, defender, skill, {
    level: 50,
    weather: 'rain',
    critical: false
});

// æš´å‡»åˆ¤å®š
DamageCalculator.checkCritical(attacker, { highCritical: true });

// å‘½ä¸­åˆ¤å®š
DamageCalculator.checkHit(attacker, defender, skill);
```

---

### 2ï¸âƒ£ TypeEffectiveness - å±æ€§ç›¸å…‹æ¨¡å—

**æ–‡ä»¶ä½ç½®ï¼š** `systems/battle/TypeEffectiveness.js`

**èŒè´£ï¼š** è®¡ç®—å’Œæ˜¾ç¤ºå±æ€§ç›¸å…‹å…³ç³»

**æ ¸å¿ƒåŠŸèƒ½ï¼š**
- âœ… å±æ€§ç›¸å…‹å€ç‡è®¡ç®—
- âœ… åŒå±æ€§ç»„åˆè®¡ç®—
- âœ… æ–‡å­—æè¿°ç”Ÿæˆ
- âœ… å…ç–«åˆ¤å®š
- âœ… æ•ˆæœæ‹”ç¾¤/ä¸ä½³åˆ¤å®š

**APIï¼š**
```javascript
// è®¡ç®—å±æ€§ç›¸å…‹
const effectiveness = TypeEffectiveness.calculate('fire', ['grass', 'bug']);
// è¿”å›: 4 (ç«å…‹è‰Ã—2, ç«å…‹è™«Ã—2)

// è·å–æ–‡å­—æè¿°
const text = TypeEffectiveness.getEffectivenessText(4);
// è¿”å›: "ğŸ’¥ æ•ˆæœæ‹”ç¾¤ï¼ï¼ˆ4å€ä¼¤å®³ï¼‰"

// æ˜¾ç¤ºä¿¡æ¯
TypeEffectiveness.display(effectiveness, addBattleLog);

// åˆ¤å®šæ–¹æ³•
TypeEffectiveness.isImmune('electric', ['ground']); // true
TypeEffectiveness.isSuperEffective('water', ['fire']); // true
```

---

### 3ï¸âƒ£ StatusEffectManager - çŠ¶æ€æ•ˆæœç®¡ç†æ¨¡å—

**æ–‡ä»¶ä½ç½®ï¼š** `systems/battle/StatusEffectManager.js`

**èŒè´£ï¼š** ç®¡ç†å®å¯æ¢¦çš„çŠ¶æ€æ•ˆæœ

**æ”¯æŒçš„çŠ¶æ€ï¼š**
- ğŸŸ£ **poison** - ä¸­æ¯’ï¼ˆæ¯å›åˆæŸå¤±æœ€å¤§HPçš„1/8ï¼‰
- ğŸ”¥ **burn** - ç¼ä¼¤ï¼ˆæ¯å›åˆæŸå¤±æœ€å¤§HPçš„1/16ï¼Œç‰©æ”»å‡åŠï¼‰
- âš¡ **paralysis** - éº»ç—¹ï¼ˆé€Ÿåº¦é™ä½75%ï¼‰
- ğŸ’¤ **sleep** - ç¡çœ ï¼ˆ1-3å›åˆæ— æ³•è¡ŒåŠ¨ï¼‰
- â„ï¸ **freeze** - å†°å†»ï¼ˆ20%æ¦‚ç‡è§£å†»ï¼‰
- ğŸ˜µ **confusion** - æ··ä¹±ï¼ˆ50%æ¦‚ç‡è‡ªä¼¤ï¼‰

**APIï¼š**
```javascript
const manager = new StatusEffectManager(eventBus);

// åº”ç”¨çŠ¶æ€
await manager.applyStatus(pokemon, 'burn', skill);

// å¤„ç†çŠ¶æ€æ•ˆæœï¼ˆæ¯å›åˆè°ƒç”¨ï¼‰
await manager.processStatusEffect(pokemon);

// ç§»é™¤çŠ¶æ€
await manager.removeStatus(pokemon);

// æ£€æŸ¥å…ç–«
manager.isImmune(pokemon, 'burn'); // ç«ç³»å…ç–«ç¼ä¼¤
```

---

### 4ï¸âƒ£ ActionExecutor - åŠ¨ä½œæ‰§è¡Œæ¨¡å—

**æ–‡ä»¶ä½ç½®ï¼š** `systems/battle/ActionExecutor.js`

**èŒè´£ï¼š** æ‰§è¡Œæˆ˜æ–—ä¸­çš„å„ç§åŠ¨ä½œ

**æ”¯æŒçš„åŠ¨ä½œç±»å‹ï¼š**
- âš”ï¸ **æŠ€èƒ½** - ä½¿ç”¨æŠ€èƒ½æ”»å‡»
- ğŸ”„ **æ¢å®å¯æ¢¦** - åˆ‡æ¢å‡ºæˆ˜å®å¯æ¢¦
- ğŸ’ **ä½¿ç”¨é“å…·** - ä½¿ç”¨æˆ˜æ–—é“å…·

**APIï¼š**
```javascript
const executor = new ActionExecutor(
    eventBus,
    DamageCalculator,
    TypeEffectiveness,
    statusManager
);

// æ‰§è¡ŒæŠ€èƒ½
await executor.executeSkill({
    pokemon: attacker,
    skill: move,
    target: defender,
    side: 'player'
}, addBattleLog);

// æ‰§è¡Œæ¢å®å¯æ¢¦
await executor.executeSwitch(action, addBattleLog);

// æ‰§è¡Œä½¿ç”¨é“å…·
await executor.executeItem(action, addBattleLog);
```

---

### 5ï¸âƒ£ BattlePhaseHandler - æˆ˜æ–—é˜¶æ®µå¤„ç†æ¨¡å—

**æ–‡ä»¶ä½ç½®ï¼š** `systems/battle/BattlePhaseHandler.js`

**èŒè´£ï¼š** å¤„ç†æˆ˜æ–—çš„å„ä¸ªé˜¶æ®µ

**æˆ˜æ–—é˜¶æ®µï¼š**
1. **TURN_START** - å›åˆå¼€å§‹
2. **ACTION_PRIORITY** - åŠ¨ä½œä¼˜å…ˆçº§æ’åº
3. **ACTION_EXECUTE** - æ‰§è¡ŒåŠ¨ä½œ
4. **ABILITY_TRIGGER** - ç‰¹æ€§è§¦å‘
5. **STATUS_EFFECT** - çŠ¶æ€æ•ˆæœå¤„ç†
6. **TURN_END** - å›åˆç»“æŸ

**APIï¼š**
```javascript
const handler = new BattlePhaseHandler(
    eventBus,
    actionExecutor,
    statusManager
);

// å¤„ç†å›åˆå¼€å§‹
await handler.handleTurnStart(gameState, turnNumber, addBattleLog);

// åŠ¨ä½œä¼˜å…ˆçº§æ’åº
const sortedActions = handler.handleActionPriority(actions);

// æ‰§è¡ŒåŠ¨ä½œ
await handler.handleActionExecute(action, addBattleLog);
```

---

## æˆ˜æ–—æµç¨‹

### å®Œæ•´å›åˆæµç¨‹å›¾

```
å¼€å§‹å›åˆ
    â†“
[1] TURN_START - å›åˆå¼€å§‹
    â”œâ”€ å¤©æ°”æ•ˆæœ
    â”œâ”€ åœºåœ°æ•ˆæœ
    â””â”€ è§¦å‘å›åˆå¼€å§‹äº‹ä»¶
    â†“
[2] ACTION_PRIORITY - åŠ¨ä½œæ’åº
    â”œâ”€ æŒ‰æŠ€èƒ½ä¼˜å…ˆçº§æ’åº
    â”œâ”€ ç›¸åŒä¼˜å…ˆçº§æŒ‰é€Ÿåº¦æ’åº
    â””â”€ é€Ÿåº¦ç›¸åŒéšæœºå†³å®š
    â†“
[3] ACTION_EXECUTE - æ‰§è¡ŒåŠ¨ä½œ
    â”œâ”€ å‘½ä¸­åˆ¤å®š
    â”œâ”€ ä¼¤å®³è®¡ç®—
    â”œâ”€ å±æ€§ç›¸å…‹åˆ¤å®š
    â”œâ”€ é€ æˆä¼¤å®³
    â””â”€ å¤„ç†æŠ€èƒ½æ•ˆæœ
    â†“
[4] ABILITY_TRIGGER - ç‰¹æ€§è§¦å‘
    â””â”€ æ£€æŸ¥å¹¶è§¦å‘æ‰€æœ‰ç‰¹æ€§
    â†“
[5] STATUS_EFFECT - çŠ¶æ€æ•ˆæœ
    â”œâ”€ ä¸­æ¯’ä¼¤å®³
    â”œâ”€ ç¼ä¼¤ä¼¤å®³
    â””â”€ å…¶ä»–çŠ¶æ€å¤„ç†
    â†“
[6] TURN_END - å›åˆç»“æŸ
    â”œâ”€ æ¸…ç†ä¸´æ—¶æ•ˆæœ
    â””â”€ æ›´æ–°æŒç»­å›åˆæ•°
    â†“
ç»“æŸå›åˆ
```

---

## ä½¿ç”¨æŒ‡å—

### ğŸ“¦ å®‰è£…å’ŒåŠ è½½

åœ¨HTMLæ–‡ä»¶ä¸­æŒ‰é¡ºåºåŠ è½½æ¨¡å—ï¼š

```html
<!-- 1. åŠ è½½æ•°æ®æ–‡ä»¶ -->
<script src="data/pokemon.js"></script>
<script src="data/types.js"></script>

<!-- 2. åŠ è½½æˆ˜æ–—æ¨¡å— -->
<script src="systems/battle/DamageCalculator.js"></script>
<script src="systems/battle/TypeEffectiveness.js"></script>
<script src="systems/battle/StatusEffectManager.js"></script>
<script src="systems/battle/ActionExecutor.js"></script>
<script src="systems/battle/BattlePhaseHandler.js"></script>

<!-- 3. åŠ è½½æ ¸å¿ƒç³»ç»Ÿ -->
<script src="systems/core/EventBus.js"></script>
<script src="systems/core/MicroTurnScheduler.js"></script>

<!-- 4. åŠ è½½ä¸»é€»è¾‘ -->
<script src="battle-enhanced-micro.js"></script>
```

### ğŸš€ å¿«é€Ÿå¼€å§‹

```javascript
// åˆå§‹åŒ–æˆ˜æ–—ç³»ç»Ÿ
const scheduler = new MicroTurnScheduler(battleSystem);

// æ‰§è¡Œä¸€ä¸ªå›åˆ
await scheduler.executeTurn(playerAction, opponentAction);
```

---

## æ‰©å±•å¼€å‘

### ğŸ”§ æ·»åŠ æ–°çš„çŠ¶æ€æ•ˆæœ

1. åœ¨ `StatusEffectManager.js` ä¸­æ·»åŠ æ–°çŠ¶æ€ï¼š

```javascript
async processStatusEffect(pokemon) {
    switch (status) {
        case 'newStatus':
            // å¤„ç†æ–°çŠ¶æ€çš„é€»è¾‘
            break;
    }
}
```

2. æ·»åŠ å…ç–«åˆ¤å®šï¼š

```javascript
isImmune(pokemon, status) {
    if (status === 'newStatus' && pokemon.type.includes('someType')) {
        return true;
    }
}
```

### ğŸ¯ æ·»åŠ æ–°çš„ä¼¤å®³è®¡ç®—å› ç´ 

åœ¨ `DamageCalculator.js` ä¸­æ‰©å±•ï¼š

```javascript
static calculateDamage(attacker, defender, skill, options) {
    // ... ç°æœ‰é€»è¾‘
    
    // æ·»åŠ æ–°çš„ä¿®æ­£å› ç´ 
    if (options.newFactor) {
        damage = this.applyNewFactor(damage, options.newFactor);
    }
    
    return damage;
}
```

### ğŸ“Š æ·»åŠ æ–°çš„æˆ˜æ–—é˜¶æ®µ

1. åœ¨ `BattlePhaseHandler.js` ä¸­æ·»åŠ å¤„ç†æ–¹æ³•
2. åœ¨ `MicroTurnScheduler.js` çš„ `executePhase` ä¸­æ³¨å†Œæ–°é˜¶æ®µ

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [æˆ˜æ–—ç³»ç»Ÿè¯¦ç»†æ–‡æ¡£](./BATTLE_SYSTEM_DOCUMENTATION.md)
- [æ¨¡å—APIæ–‡æ¡£](./systems/battle/README.md)
- [æ•°æ®ç»“æ„åˆ†æ](./DATA_STRUCTURE_ANALYSIS.md)

---

**ç‰ˆæœ¬ï¼š** 2.0 (æ¨¡å—åŒ–é‡æ„ç‰ˆ)  
**æœ€åæ›´æ–°ï¼š** 2025-11-17

